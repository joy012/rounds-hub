#!/usr/bin/env node
/**
 * Creates android/local.properties with sdk.dir so Gradle can find the Android SDK.
 * Required after `expo prebuild --clean` since it wipes the android folder.
 * Auto-detects SDK at default locations when ANDROID_HOME is not set.
 */

const fs = require('fs');
const path = require('path');

const localPropertiesPath = path.join(__dirname, '..', 'android', 'local.properties');

function resolveHome(dir) {
  if (dir.startsWith('~')) {
    return path.join(process.env.HOME || process.env.USERPROFILE || '', dir.slice(1));
  }
  return dir;
}

function findAndroidSdkPath() {
  if (process.env.ANDROID_HOME) {
    const resolved = path.resolve(resolveHome(process.env.ANDROID_HOME));
    if (fs.existsSync(resolved)) return resolved;
  }
  const home = process.env.HOME || process.env.USERPROFILE || '';
  const defaults = [
    path.join(home, 'Library', 'Android', 'sdk'), // macOS (Android Studio default)
    path.join(home, 'Android', 'Sdk'), // Linux
    path.join(process.env.LOCALAPPDATA || '', 'Android', 'Sdk'), // Windows
  ].filter(Boolean);
  for (const candidate of defaults) {
    const resolved = path.resolve(candidate);
    if (fs.existsSync(resolved)) return resolved;
  }
  return null;
}

const sdkPath = findAndroidSdkPath();
if (!sdkPath) {
  console.error('\n❌ Android SDK not found. Gradle needs the Android SDK path.\n');
  console.error('Either install Android Studio (SDK at default location) or set ANDROID_HOME:');
  console.error('  export ANDROID_HOME=$HOME/Library/Android/sdk  # macOS');
  console.error('  export PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools\n');
  console.error('Then run: source ~/.zshrc  (or restart the terminal)\n');
  process.exit(1);
}

const content = `# Auto-generated by scripts/ensure-android-sdk.js - do not commit if machine-specific
sdk.dir=${sdkPath.replace(/\\/g, '/')}
`;

fs.writeFileSync(localPropertiesPath, content, 'utf8');
console.log('✔ Android SDK path written to android/local.properties');
